<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Courses | Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    /* 2026 Palette */
    --bg-gradient: radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgb(219, 228, 255) 90%);
    --primary: #4338ca;      /* Indigo 700 */
    --accent: #6366f1;       /* Indigo 500 */
    --glass-bg: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.8);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    --backdrop: blur(12px);
    
    --text-main: #1e293b;
    --text-light: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
}

* { box-sizing: border-box; font-family: 'Outfit', sans-serif; }

body {
    margin: 0;
    background: var(--bg-gradient);
    color: var(--text-main);
    min-height: 100vh;
}

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- HEADER --- */
.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 5%;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(255,255,255,0.3);
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
}

.brand { display: flex; align-items: center; gap: 15px; }
.btn-back {
    text-decoration: none;
    color: var(--text-main);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 30px;
    background: #f1f5f9;
    transition: all 0.2s;
}
.btn-back:hover { background: #e2e8f0; transform: translateX(-3px); }

.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
}
.avatar {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700;
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
}
.user-info { line-height: 1.2; text-align: right; }
.user-info span { display: block; font-weight: 700; font-size: 0.9rem; }
.user-info small { color: var(--text-light); font-size: 0.75rem; }

/* --- HERO --- */
.hero {
    text-align: center;
    padding: 60px 20px 40px;
    max-width: 900px;
    margin: 0 auto;
    animation: fadeIn 0.6s ease-out;
}
.hero h1 {
    font-size: 3rem;
    margin: 0 0 15px 0;
    background: linear-gradient(135deg, var(--text-main), var(--primary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 800;
    letter-spacing: -1px;
}
.hero p { color: var(--text-light); font-size: 1.1rem; max-width: 600px; margin: 0 auto; }

/* --- GRID --- */
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px 60px; }
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 30px;
}

/* --- CARD DESIGN --- */
.card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    box-shadow: var(--glass-shadow);
    backdrop-filter: var(--backdrop);
    padding: 30px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-8px) scale(1.01);
    box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);
    border-color: rgba(255,255,255,1);
}

.status-dot {
    position: absolute;
    top: 25px; right: 25px;
    padding: 6px 14px;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.status-active { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
.status-pending { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

.card h3 {
    margin: 10px 0;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-main);
    line-height: 1.3;
}
.card-price {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 20px;
    display: block;
}
.card-price sub { font-size: 1rem; color: var(--text-light); font-weight: 500; bottom: 0.2em; }

.desc {
    color: var(--text-light);
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 20px;
    flex-grow: 1;
}

.meta-list {
    list-style: none;
    padding: 0;
    margin: 0 0 25px 0;
}
.meta-list li {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-main);
    font-size: 0.9rem;
    margin-bottom: 8px;
    font-weight: 500;
}
.meta-list li i { color: var(--accent); font-size: 0.8rem; }

/* --- BUTTONS --- */
.actions { display: grid; gap: 10px; margin-top: auto; }

.btn {
    border: none;
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    transition: transform 0.2s, filter 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}
.btn:active { transform: scale(0.96); }

/* Enroll / Primary */
.btn-enroll {
    background: var(--text-main);
    color: white;
}
.btn-enroll:hover { background: black; }

/* Access / Success */
.btn-access {
    background: var(--success);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Pending Group */
.pending-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
/* CHANGED: Renamed btn-invoice to btn-ticket for clarity */
.btn-ticket {
    background: #e0e7ff;
    color: var(--primary);
}
.btn-cancel {
    background: #fee2e2;
    color: var(--danger);
}
.btn-ticket:hover, .btn-cancel:hover { filter: brightness(0.95); }

/* Loading */
.loader { grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-light); }

@media (max-width: 600px) {
    .navbar { padding: 15px; flex-direction: column-reverse; gap: 15px; }
    .brand { width: 100%; justify-content: space-between; }
    .hero h1 { font-size: 2.2rem; }
    .user-profile { width: 100%; justify-content: flex-end; }
}
</style>
</head>
<body>

<nav class="navbar">
    <div class="brand">
        <a href="student.html" class="btn-back"><i class="fas fa-arrow-left"></i> Dashboard</a>
        <h3 style="margin:0;">FBA Courses</h3>
    </div>
    <div class="user-profile">
        <div class="user-info">
            <span id="studentEmail">Loading...</span>
            <small id="studentIdDisplay">ID: ...</small>
        </div>
        <div class="avatar" id="avatarLetter"></div>
    </div>
</nav>

<div class="hero">
    <h1>Upgrade Your Skills</h1>
    <p>Premium specialized training for the modern food entrepreneur. Select a module below to begin.</p>
</div>

<main class="container">
    <div class="grid" id="coursesGrid">
        <div class="loader">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>
            Loading Academy Data...
        </div>
    </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.firebasestorage.app",
  messagingSenderId: "634331456872",
  appId: "1:634331456872:web:6dae360c5e28d8356562dd",
  measurementId: "G-96XXYG1VR2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Data Model
const courses = [
  { name: "Food Business Management Course", price: 49, overview: "Master compliance, models, and operations.", curriculum: ["Business Models", "Full Compliance", "Digital Marketing"] },
  { name: "Financial Management for Food Processors", price: 59, overview: "Unit costing, yield analysis, and profit.", curriculum: ["Costing & Yields", "Pricing Strategy", "Cash Flow Mastery"] },
  { name: "Food Value Addition Course for Farmers", price: 45, overview: "Turn raw produce into branded products.", curriculum: ["Post-Harvest Tech", "Smart Packaging", "Brand Building"] },
  { name: "New Product Development and Management", price: 69, overview: "From kitchen recipe to supermarket shelf.", curriculum: ["Prototyping", "Sensory Eval", "Regulatory Law"] },
  { name: "Management", price: 39, overview: "Leadership tactics for high-pressure environments.", curriculum: ["Leadership Skills", "Ethics", "Decision Making"] }
];

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  currentUser = user;

  // 1. UI: Set Email & Avatar
  const email = user.email;
  document.getElementById("studentEmail").textContent = email;
  document.getElementById("avatarLetter").textContent = email.charAt(0).toUpperCase();

  // 2. Fetch Student Data (For Courses Paid & Student ID)
  const studentSnap = await getDoc(doc(db, "students", user.uid));
  let paidCourses = [];
  let studentId = "N/A";

  if (studentSnap.exists()) {
      const data = studentSnap.data();
      paidCourses = data.coursesPaid || [];
      // Attempt to get student ID from firestore, fallback to UID
      studentId = data.studentId || data.id || `ST-${user.uid.substr(0,5).toUpperCase()}`;
  }
  document.getElementById("studentIdDisplay").textContent = `ID: ${studentId}`;

  // 3. Fetch Pending Payments (Firestore)
  // We store object { name: "Course", docId: "xyz" } to allow deletion
  const payQuery = query(collection(db, "payments"), where("studentId", "==", user.uid), where("status", "==", "pending"));
  const paySnap = await getDocs(payQuery);
  
  let pendingData = [];
  paySnap.forEach(doc => {
      pendingData.push({ 
          name: doc.data().courseName, 
          docId: doc.id 
      });
  });

  // 4. LocalStorage Pending Check (Merge with Firestore)
  const localStatus = JSON.parse(localStorage.getItem("courseStatus")) || {};
  const studentLocalData = localStatus[email] || {};
  
  Object.keys(studentLocalData).forEach(cName => {
      // If locally pending but not found in Firestore list, add it (without docId, effectively local only)
      if (studentLocalData[cName] === "pending") {
          const alreadyExists = pendingData.find(p => p.name === cName);
          if (!alreadyExists) {
              pendingData.push({ name: cName, docId: null });
          }
      }
  });

  renderCourses(paidCourses, pendingData);
});

function renderCourses(paidList, pendingList) {
  const grid = document.getElementById("coursesGrid");
  grid.innerHTML = "";

  courses.forEach(course => {
    let statusBadge = "";
    let actionArea = "";

    // Check Status
    const isPaid = paidList.includes(course.name);
    // Find if pending (returns the object if found)
    const isPendingObj = pendingList.find(p => p.name === course.name);

    if (isPaid) {
      // --- ACTIVE STATE ---
      statusBadge = `<div class="status-dot status-active">Active</div>`;
      actionArea = `
        <button class="btn btn-access" onclick="openCourse('${course.name}')">
            <i class="fas fa-door-open"></i> Enter Classroom
        </button>`;
    
    } else if (isPendingObj) {
      // --- PENDING STATE ---
      statusBadge = `<div class="status-dot status-pending">Payment Pending</div>`;
      // Pass the docId (if it exists) to the cancel function
      const docIdParam = isPendingObj.docId ? `'${isPendingObj.docId}'` : 'null';
      
      // CHANGED: Replaced Invoice button with Open Ticket button
      actionArea = `
        <div class="pending-actions">
            <button class="btn btn-ticket" onclick="openTicket()">
                <i class="fas fa-ticket-alt"></i> Open Ticket
            </button>
            <button class="btn btn-cancel" onclick="cancelOrder('${course.name}', ${docIdParam})">
                <i class="fas fa-trash"></i> Cancel
            </button>
        </div>
      `;
    } else {
      // --- DEFAULT / ENROLL STATE ---
      actionArea = `
        <button class="btn btn-enroll" onclick="enroll('${course.name}', ${course.price})">
            <i class="fas fa-credit-card"></i> Enroll Now
        </button>`;
    }

    // Render Card
    grid.innerHTML += `
      <div class="card">
        ${statusBadge}
        <h3>${course.name}</h3>
        <span class="card-price">$${course.price} <sub>/ USD</sub></span>
        <p class="desc">${course.overview}</p>
        
        <ul class="meta-list">
             ${course.curriculum.map(c => `<li><i class="fas fa-check-circle"></i> ${c}</li>`).join("")}
        </ul>

        <div class="actions">
            ${actionArea}
        </div>
      </div>
    `;
  });
}

// --- GLOBAL ACTIONS ---

window.enroll = (name, price) => {
  window.location.href = `student-details.html?name=${encodeURIComponent(name)}&price=${price}`;
};

window.openCourse = (courseName) => {
  const coursePages = {
      "Management": "management_course.html",
      "Food Business Management Course": "course-food-business-management.html",
      "Financial Management for Food Processors": "course-financial-management.html",
      "Food Value Addition Course for Farmers": "course-value-addition.html",
      "New Product Development and Management": "course-product-development.html"
  };
  
  const page = coursePages[courseName];
  if (page) {
      window.location.href = page;
  } else {
      alert("Classroom content is updating. Contact support.");
  }
};

// CHANGED: Replaced viewInvoice with openTicket
window.openTicket = () => {
    window.location.href = "https://foodpreneursbussinessacademy.github.io/Foodprenuerbusinessacademy/tickets.html";
};

window.cancelOrder = async (courseName, docId) => {
    if(!confirm(`Are you sure you want to cancel the invoice for ${courseName}?`)) return;

    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        // 1. Remove from LocalStorage
        if (currentUser && currentUser.email) {
            const localStatus = JSON.parse(localStorage.getItem("courseStatus")) || {};
            if (localStatus[currentUser.email]) {
                delete localStatus[currentUser.email][courseName];
                localStorage.setItem("courseStatus", JSON.stringify(localStatus));
            }
        }

        // 2. Remove from Firestore (if a valid docId exists)
        if (docId) {
            await deleteDoc(doc(db, "payments", docId));
        }

        alert("Invoice cancelled successfully.");
        window.location.reload();

    } catch (error) {
        console.error("Error cancelling:", error);
        alert("Could not cancel invoice. Please try again.");
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};
</script>
</body>
</html>
