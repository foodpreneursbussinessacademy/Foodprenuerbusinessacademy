<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice View</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- EXACT STYLES FROM YOUR PREVIEW PAGE --- */
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --bg-color: #f3f4f6;
            --text-dark: #1f2937;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }

        /* Container for the page view */
        .page-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Navigation Buttons */
        .nav-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .btn-back { background: #e5e7eb; color: #374151; }
        .btn-download { background: var(--primary); color: white; }
        .btn-download:hover { background: #4338ca; }

        /* --- THE INVOICE PAPER (Copied from your modal) --- */
        #invoice-paper {
            background: #fff;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden; /* Ensures watermark stays inside */
        }

        /* Unpaid Watermark */
        .unpaid-stamp {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            color: #c0392b;
            border: 4px solid #c0392b;
            padding: 10px 40px;
            font-size: 3rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 5px;
            opacity: 0.25;
            pointer-events: none;
            z-index: 0;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
        }
        
        .paid-stamp {
            color: #10b981; /* Green */
            border-color: #10b981;
        }

        /* Invoice Header */
        .inv-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; position: relative; z-index: 1; }
        .inv-logo img { height: 80px; width: auto; object-fit: contain; }
        .inv-title { text-align: right; }
        .inv-title h2 { margin: 0; color: #222; font-size: 32px; letter-spacing: 2px; }
        .inv-meta { margin-top: 10px; font-size: 14px; color: #666; }

        /* Invoice Table */
        .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; position: relative; z-index: 1; }
        .inv-table th { text-align: left; background: #f8f9fa; padding: 12px; font-size: 12px; text-transform: uppercase; color: #555; border-bottom: 2px solid #ddd; }
        .inv-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        .inv-total-row td { border-top: 2px solid #333; font-weight: 700; font-size: 16px; color: #000; }

        /* Payment Details Boxes */
        .pay-box { background: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative; z-index: 1; }
        .pay-header { font-weight: 700; color: #004085; margin-bottom: 10px; font-size: 15px; border-bottom: 1px solid #b8daff; padding-bottom: 5px; display: block; }
        .pay-details { font-size: 14px; line-height: 1.6; color: #333; }
        .pay-label { font-weight: 600; color: #555; min-width: 100px; display: inline-block; }

        .proof-box { background: #fff8f0; border-color: #ffeeba; }
        .proof-header { color: #856404; }

        .inv-footer { text-align: center; font-size: 12px; color: #777; margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; position: relative; z-index: 1; }

        /* Hide buttons when printing */
        @media print {
            body { background: white; padding: 0; }
            .nav-actions { display: none; }
            .page-container { max-width: 100%; margin: 0; box-shadow: none; }
            #invoice-paper { box-shadow: none; padding: 20px; }
        }
        
        /* Loading State */
        .loading-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div class="page-container">
        <div class="nav-actions">
            <a href="courses.html" class="btn btn-back"><i class="fas fa-arrow-left"></i> Back to Courses</a>
            <button onclick="downloadPDF()" class="btn btn-download"><i class="fas fa-file-pdf"></i> Download PDF</button>
        </div>

        <div id="invoice-paper">
            <div id="loading-msg" class="loading-overlay">Loading Invoice Data...</div>
            
            <div id="watermark" class="unpaid-stamp">UNPAID</div>
            
            <div class="inv-header">
              <div class="inv-logo">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png" alt="Company Logo" />
              </div>
              <div class="inv-title">
                <h2>INVOICE</h2>
                <div class="inv-meta">
                  <strong>Inv #:</strong> <span id="inv-num">...</span><br />
                  <strong>Date:</strong> <span id="inv-date">...</span><br/>
                  <strong>Method:</strong> <span id="inv-method">...</span>
                </div>
              </div>
            </div>
    
            <div style="margin-bottom:20px; font-size: 14px;">
                <strong>Bill To:</strong> <span id="inv-student-name">...</span><br>
                <span id="inv-student-email" style="color:#666; font-size: 13px;">...</span>
            </div>
    
            <table class="inv-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th width="100">Type</th>
                  <th width="100" style="text-align:right">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="inv-course-name">Loading Course...</td>
                  <td>Online Course</td>
                  <td id="inv-course-price" style="text-align:right">$0.00</td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="inv-total-row">
                  <td colspan="2" style="text-align:right;">Grand Total:</td>
                  <td id="inv-final-total" style="text-align:right">$0.00</td>
                </tr>
              </tfoot>
            </table>
    
            <div class="pay-box">
              <span class="pay-header">PAYMENT INSTRUCTIONS</span>
              <div class="pay-details">
                <div><span class="pay-label">One Money:</span> 0718625498</div>
                <div><span class="pay-label">Ecocash:</span> 0773371163</div>
                <div><span class="pay-label">Bank Acc:</span> FBC / CBZ Academy Account</div>
              </div>
            </div>
    
            <div class="pay-box proof-box">
                <span class="pay-header proof-header">PROOF OF PAYMENT</span>
                <div class="pay-details">
                  Please send proof of payment to:
                  <div style="margin-top:5px;"><strong>WhatsApp:</strong> +263 773 371 163</div>
                  <div><strong>Email:</strong> petronela.hr@foodbusinessac.co.zw</div>
                </div>
            </div>
    
            <div class="inv-footer">
              Thank you for your business! Food Business Academy.
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
            authDomain: "students-login-29409.firebaseapp.com",
            projectId: "students-login-29409",
            storageBucket: "students-login-29409.firebasestorage.app",
            messagingSenderId: "634331456872",
            appId: "1:634331456872:web:6dae360c5e28d8356562dd",
            measurementId: "G-96XXYG1VR2"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. GET INVOICE ID FROM URL ---
        const urlParams = new URLSearchParams(window.location.search);
        // Supports ?id=FBA-123 or ?invoiceId=FBA-123
        const invoiceId = urlParams.get('id') || urlParams.get('invoiceId');

        // --- 3. FETCH & DISPLAY DATA ---
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Optional: Redirect to login if sensitive, or just show minimal view
                console.log("User not logged in");
            }

            if (invoiceId) {
                try {
                    const docRef = db.collection("payments").doc(invoiceId);
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        const data = docSnap.data();
                        populateInvoice(data, docSnap.id);
                    } else {
                        alert("Invoice not found!");
                        document.getElementById('loading-msg').textContent = "Invoice Not Found";
                    }
                } catch (error) {
                    console.error("Error fetching invoice:", error);
                    document.getElementById('loading-msg').textContent = "Error loading invoice.";
                }
            } else {
                // FALLBACK: If no ID in URL, try to load data passed via URL params (preview mode)
                const nameParam = urlParams.get('name');
                const priceParam = urlParams.get('price');
                if(nameParam && priceParam) {
                     populateInvoice({
                        invoiceNumber: "PREVIEW",
                        courseName: nameParam,
                        price: priceParam,
                        paymentMethod: "Pending Selection",
                        studentName: user ? user.displayName : "Student",
                        email: user ? user.email : "...",
                        createdAt: { toDate: () => new Date() }, // Fake timestamp
                        status: "pending"
                     }, "PREVIEW");
                } else {
                    document.getElementById('loading-msg').textContent = "No Invoice Specified.";
                }
            }
        });

        function populateInvoice(data, id) {
            // Remove Loading
            document.getElementById('loading-msg').style.display = 'none';

            // 1. Basic Fields
            document.getElementById('inv-num').textContent = data.invoiceNumber || id;
            document.getElementById('inv-method').textContent = data.paymentMethod || "N/A";
            document.getElementById('inv-student-name').textContent = data.studentName || "Student";
            document.getElementById('inv-student-email').textContent = data.email || "";
            document.getElementById('inv-course-name').textContent = data.courseName || "Course";
            
            // 2. Prices
            const price = data.price || "0.00";
            document.getElementById('inv-course-price').textContent = "$" + price;
            document.getElementById('inv-final-total').textContent = "$" + price;

            // 3. Date Formatting
            if (data.createdAt && data.createdAt.toDate) {
                const date = data.createdAt.toDate();
                document.getElementById('inv-date').textContent = date.toLocaleDateString();
            } else {
                document.getElementById('inv-date').textContent = new Date().toLocaleDateString();
            }

            // 4. Status / Watermark Logic
            const wm = document.getElementById('watermark');
            if (data.status === 'paid' || data.status === 'approved') {
                wm.textContent = "PAID";
                wm.classList.add('paid-stamp');
                wm.style.borderColor = "#10b981"; // Green
                wm.style.color = "#10b981";
            } else {
                wm.textContent = "UNPAID";
                wm.classList.remove('paid-stamp');
            }
        }

        // --- 4. PDF DOWNLOAD FUNCTION ---
        function downloadPDF() {
            const element = document.getElementById('invoice-paper');
            // Temporarily hide the watermark for cleaner PDF if desired, or keep it.
            // keeping it as per request.
            
            const invNum = document.getElementById("inv-num").textContent.trim();
            const opt = {
                margin: 0, 
                filename: `Invoice_${invNum}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
