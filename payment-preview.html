<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Payment Preview - Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- 1. CORE VARIABLES & RESET --- */
:root {
    --primary: #4f46e5;
    --secondary: #7c3aed;
    --bg-color: #f3f4f6;
    --card-bg: #ffffff;
    --text-dark: #1f2937;
}
* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { 
    font-family: 'Poppins', sans-serif; 
    background: var(--bg-color); 
    display: flex; justify-content: center; align-items: center; 
    min-height: 100vh; padding: 20px;
}

/* --- 2. SCANNING OVERLAY (NEW) --- */
#scanning-overlay {
    position: fixed; inset: 0;
    background: rgba(243, 244, 246, 0.95);
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.3s ease;
}
.spinner {
    width: 50px; height: 50px;
    border: 5px solid #ddd;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
.scan-text { font-weight: 600; color: var(--text-dark); letter-spacing: 0.5px; }

/* --- 3. CONTAINER --- */
.container { 
    width: 100%; max-width: 500px; 
    background: var(--card-bg); 
    padding: 40px 30px; 
    border-radius: 20px; 
    box-shadow: 0 20px 40px rgba(79, 70, 229, 0.15); 
    text-align: center;
    border-top: 5px solid var(--secondary);
}

.logo-img { max-width: 150px; margin: 0 auto 20px auto; display: block; }
h2 { font-size: 22px; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
.sub-text { font-size: 14px; color: #6b7280; margin-bottom: 25px; }

/* Details Box */
.details-box {
    background: #f9fafb; border-radius: 12px;
    padding: 20px; margin-bottom: 25px;
    text-align: left; border: 1px dashed #d1d5db;
}
.detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; color: var(--text-dark); }
.detail-row:last-child { margin-bottom: 0; }
.detail-row span.label { color: #6b7280; font-weight: 500; }
.detail-row span.value { font-weight: 600; color: var(--primary); text-align: right; }

/* Payment Grid */
.payment-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 25px; }
.payment-card {
    background: #fff; border: 2px solid #e5e7eb; border-radius: 12px;
    padding: 10px; cursor: pointer; transition: all 0.3s ease;
    height: 80px; display: flex; align-items: center; justify-content: center;
    position: relative; overflow: hidden;
}
.payment-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
.payment-card.active { border-color: var(--secondary); background: #f5f3ff; }
.payment-card.active::after {
    content: 'âœ”'; position: absolute; top: 2px; right: 5px;
    font-size: 12px; color: var(--secondary); font-weight: bold;
}

.main-btn {
    width: 100%; padding: 16px; background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
    cursor: pointer; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    transition: transform 0.2s;
}
.main-btn:hover { transform: translateY(-2px); }
.main-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

/* --- 4. INVOICE MODAL --- */
#invoice-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 10000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(5px); padding: 20px;
}
#invoice-container {
    background: #fff; width: 100%; max-width: 700px;
    border-radius: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; max-height: 90vh;
}
#invoice-scroll-area { padding: 40px; overflow-y: auto; position: relative; }

/* Invoice Elements */
.unpaid-stamp {
    position: absolute; top: 35%; left: 50%;
    transform: translate(-50%, -50%) rotate(-20deg);
    border: 5px solid #d93025; color: #d93025;
    font-size: 50px; font-weight: 900; padding: 10px 20px;
    opacity: 0.15; pointer-events: none; z-index: 0;
}
.inv-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
.inv-logo img { height: 70px; }
.inv-title { text-align: right; }
.inv-title h2 { margin: 0; font-size: 28px; letter-spacing: 1px; }
.inv-meta { margin-top: 10px; font-size: 14px; color: #666; }

.inv-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
.inv-table th { text-align: left; background: #f8f9fa; padding: 12px; font-size: 12px; color: #555; border-bottom: 2px solid #ddd; }
.inv-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
.inv-total-row td { border-top: 2px solid #333; font-weight: 700; font-size: 16px; }

.pay-box { background: #f0f7ff; border: 1px solid #cce5ff; border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 14px; }
.proof-box { background: #fff8f0; border-color: #ffeeba; }

.inv-actions {
    background: #f1f1f1; padding: 15px; border-top: 1px solid #ddd;
    display: flex; justify-content: flex-end; gap: 10px; border-radius: 0 0 4px 4px;
}
.inv-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 14px; }
.btn-finish { background: var(--primary); color: #fff; }
.btn-download { background: #10b981; color: #fff; display: flex; align-items: center; gap: 5px;}
</style>
</head>

<body>

<div id="scanning-overlay">
    <div class="spinner"></div>
    <div class="scan-text">Scanning Payment Status...</div>
</div>

<div class="container">
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png" alt="Logo" class="logo-img">
  
  <h2>Enrollment Summary</h2>
  <p class="sub-text">Confirm details to generate your invoice.</p>

  <div class="details-box">
    <div class="detail-row">
        <span class="label">Email:</span>
        <span class="value" id="displayEmail">...</span>
    </div>
    <div class="detail-row">
        <span class="label">Course:</span>
        <span class="value" id="displayCourse">...</span>
    </div>
    <div class="detail-row" style="border-top: 1px solid #e5e7eb; padding-top: 10px; margin-top: 10px;">
        <span class="label">Total Amount:</span>
        <span class="value" style="font-size: 18px;" id="displayPrice">...</span>
    </div>
  </div>

  <div style="text-align:left; font-weight:600; margin-bottom:10px; font-size:14px;">Select Payment Method:</div>
  <input type="hidden" id="method" value="Ecocash">

  <div class="payment-grid">
    <div class="payment-card active" onclick="selectPayment('Ecocash', this)">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCOPxJALDl8rinCr4j5gKvHQCpFn5RjSNX4o2ZgKZdus_g_naLRz35VcSQknCqVYUWWrhpmE_f3OOPgnjByqIM4JFYeB_0ZKCQxlRgesgK5PoPxo4JjacOmrmyTXpzf-bAfc6ZEt8_88LFQZEEUN1p9yb-zdoqKA8UrGntxMjWrC6dcYZQi0rK3i27jDOa/s1600/EcoCash%20%281%29.png" alt="Ecocash">
    </div>
    <div class="payment-card" onclick="selectPayment('Bank Transfer', this)">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEitQyz359bQN-qUKKbaBPz0pEF11jeXScTl4rmkmeWpLqLFnm42tZ6eolAZJVx1kdGxo8gxgtLKPWOJZ1l4A_yr3HQXk4gar_xvwrQg6UXRQBzfzmN4b4wNsvbdmrK8_56qX2p1vAQFckXv-S2e-6C78GtoLe1T3J156Pq8kz17imMQX8SjF9CSpl4Txujj/s1600/%5BCITYPNG.COM%5DMasterCard%20&%20Visa%20Cards%20Logos%20Icons%20-%201500x1500.png" alt="Bank">
    </div>
    <div class="payment-card" onclick="selectPayment('One Money', this)">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgBFwR6y4tJP-_NQ_l2TspkmOZOd4c4lHPbTjhqdD_r68NAdzPTZxjW7Ns1ZcMQMch1b8yd1HMzcw7EKkdyJDxUwfNgsdRDZJnMy16a2ldFRV95MOsiqelfNMlsV9L_dXgow0019mQ9uNa6DTSYGYCB6xYXVhaur-1AGfnqalmHqesEG0z-XViwC81MwON1/s1600/2d0d78c7-f8c3-4169-8a6c-81b036eb2796.jpg" alt="OneMoney">
    </div>
  </div>

  <button type="button" id="payBtn" class="main-btn" onclick="proceedPayment()">Generate Invoice & Pay</button>
  <p style="margin-top:15px; font-size:13px; color:#666;">
     <a href="courses.html" style="color:var(--secondary); text-decoration:none;">Cancel</a>
  </p>
</div>

<div id="invoice-modal-overlay">
  <div id="invoice-container">
    <div id="invoice-content">
      <div id="invoice-scroll-area">
        <div class="unpaid-stamp">UNPAID</div>
        <div class="inv-header">
          <div class="inv-logo"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png" alt="Logo" /></div>
          <div class="inv-title">
            <h2>INVOICE</h2>
            <div class="inv-meta">
              <strong>Inv #:</strong> <span id="inv-num">...</span><br />
              <strong>Date:</strong> <span id="inv-date">...</span><br/>
              <strong>Method:</strong> <span id="inv-method">...</span>
            </div>
          </div>
        </div>
        <table class="inv-table">
          <thead><tr><th>Description</th><th>Type</th><th style="text-align:right">Total</th></tr></thead>
          <tbody>
            <tr><td id="inv-course-name">Course</td><td>Online</td><td id="inv-course-price" style="text-align:right">...</td></tr>
          </tbody>
          <tfoot><tr class="inv-total-row"><td colspan="2" style="text-align:right;">Grand Total:</td><td id="inv-final-total" style="text-align:right">...</td></tr></tfoot>
        </table>
        <div class="pay-box">
          <strong>PAYMENT INSTRUCTIONS</strong><br>
          One Money: 0718625498 | Ecocash: 0773371163 | Bank: FBC / CBZ Academy
        </div>
        <div class="pay-box proof-box">
            <strong>PROOF OF PAYMENT</strong><br>
            Send proof to WhatsApp: +263 773 371 163 or petronela.hr@foodbusinessac.co.zw
        </div>
      </div>
    </div>
    <div class="inv-actions">
      <button class="inv-btn btn-finish" onclick="finishAndRedirect()">Finish & Return</button>
      <button class="inv-btn btn-download" onclick="downloadPDF()">Download PDF</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409",
  storageBucket: "students-login-29409.firebasestorage.app",
  messagingSenderId: "634331456872",
  appId: "1:634331456872:web:6dae360c5e28d8356562dd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Global State
let currentInvoiceId = new URLSearchParams(window.location.search).get('invoiceId');
let courseData = {
    name: new URLSearchParams(window.location.search).get('courseName'),
    price: new URLSearchParams(window.location.search).get('price'),
    id: new URLSearchParams(window.location.search).get('courseId')
};
let userData = {};

// --- 1. MAIN LOGIC WITH STRICT REDIRECTION ---
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  userData.uid = user.uid;
  userData.email = user.email;

  const overlay = document.getElementById("scanning-overlay");

  try {
    // A. If an Invoice ID exists in URL, Fetch and Validate
    if (currentInvoiceId) {
        const docRef = doc(db, "payments", currentInvoiceId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();

            // Security Check: Is this MY invoice?
            if (data.studentId !== user.uid) {
                window.location.href = "student.html";
                return;
            }

            // STRICT REDIRECTION: If Paid OR Pending -> Kick out
            if (data.status === 'paid' || data.status === 'pending') {
                console.warn("Invoice active/paid. Redirecting.");
                window.location.href = "student.html";
                return;
            }

            // ENROLLMENT CHECK: Check User profile
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists() && userSnap.data().enrolled_courses) {
                if (userSnap.data().enrolled_courses.includes(data.courseId)) {
                    window.location.href = "student.html";
                    return;
                }
            }

            // All checks passed. Load Data from DB.
            courseData.name = data.courseName;
            courseData.price = data.price;
            courseData.id = data.courseId;
        } else {
            // Invoice ID in URL is invalid/deleted. Treat as NEW transaction.
            console.log("Invoice ID invalid. Falling back to creation mode.");
            currentInvoiceId = null; // Reset to force new generation
        }
    }

    // B. If No Invoice ID (or invalid) -> Fallback to URL Params
    // If we don't even have courseName from URL, we can't do anything.
    if (!courseData.name || !courseData.price) {
        // alert("No course details found.");
        window.location.href = "courses.html";
        return;
    }

    // Populate UI
    document.getElementById("displayEmail").textContent = user.email;
    document.getElementById("displayCourse").textContent = courseData.name;
    document.getElementById("displayPrice").textContent = "$" + courseData.price;

    // HIDE OVERLAY only after all checks are done
    overlay.style.opacity = "0";
    setTimeout(() => { overlay.style.display = "none"; }, 300);

  } catch (error) {
    console.error("Error during init:", error);
    // On critical error, fallback to student dashboard
    window.location.href = "student.html";
  }
});

// --- 2. SELECT METHOD ---
window.selectPayment = (methodValue, cardElement) => {
    document.getElementById("method").value = methodValue;
    document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('active'));
    cardElement.classList.add('active');
}

// --- 3. PROCEED PAYMENT (GENERATE OR UPDATE) ---
window.proceedPayment = async () => {
    const payBtn = document.getElementById("payBtn");
    payBtn.disabled = true;
    payBtn.textContent = "Processing...";

    const method = document.getElementById("method").value;
    const dateStr = new Date().toLocaleDateString();

    try {
        // If we don't have an invoice ID yet, Create one.
        if (!currentInvoiceId) {
            currentInvoiceId = "INV-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
            
            // USE setDoc to GUARANTEE creation
            await setDoc(doc(db, "payments", currentInvoiceId), {
                studentId: userData.uid,
                email: userData.email,
                courseId: courseData.id || "unknown",
                courseName: courseData.name,
                price: courseData.price,
                status: "created", // Initial status, not pending yet
                createdAt: new Date(),
                paymentMethod: method,
                invoiceNumber: currentInvoiceId
            });
        } 
        // If ID existed, just update method
        else {
             await updateDoc(doc(db, "payments", currentInvoiceId), {
                paymentMethod: method,
                updatedAt: new Date()
            });
        }

        // Populate Modal
        document.getElementById("inv-num").textContent = currentInvoiceId;
        document.getElementById("inv-date").textContent = dateStr;
        document.getElementById("inv-method").textContent = method;
        document.getElementById("inv-course-name").textContent = courseData.name;
        document.getElementById("inv-course-price").textContent = "$" + courseData.price;
        document.getElementById("inv-final-total").textContent = "$" + courseData.price;

        // Show Modal
        document.getElementById("invoice-modal-overlay").style.display = "flex";

    } catch (e) {
        console.error("Payment setup error:", e);
        alert("Could not generate invoice. Please try again.");
    } finally {
        payBtn.disabled = false;
        payBtn.textContent = "Generate Invoice & Pay";
    }
}

// --- 4. FINISH ---
window.finishAndRedirect = () => {
    window.location.href = "student.html"; // Or courses.html based on pref
}

window.downloadPDF = () => {
  const element = document.getElementById('invoice-content');
  const invNum = document.getElementById("inv-num").textContent;
  const opt = {
      margin: 0.3, filename: `Invoice-${invNum}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}
</script>

</body>
</html>
