<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Payment Preview - Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{ font-family:'Poppins',sans-serif; background:#f4f6fb; padding:20px; }
.container{ max-width:480px; margin:auto; background:#fff; padding:30px; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.08); }
h2{text-align:center; margin-bottom:15px; color: #1e3a8a;}
p{margin:10px 0; font-size:15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;}
strong { color: #4b5563; }

select,button{ width:100%; padding:14px; margin-top:15px; border-radius:10px; border:1px solid #ddd; font-size: 16px; }
button{ background:#2563eb; color:#fff; font-weight:600; border:none; cursor:pointer; transition: 0.3s; }
button:hover{background:#6d28d9; transform: translateY(-2px);}

#invoicePopup{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; overflow-y: auto; }
#invoiceBox{ background:#fff; max-width:420px; margin:5% auto; padding:25px; border-radius:16px; }
.greenBtn{background:#22c55e; margin-top: 10px;}
.blueBtn{background:#0ea5e9; margin-top: 20px;}
.instruction-box { background: #f9fafb; padding: 15px; border-radius: 10px; border: 1px dashed #cbd5e1; margin-top: 15px; font-size: 13px; }
</style>
</head>

<body>

<div class="container">
  <h2>Enrollment Summary</h2>

  <p><strong>Name:</strong> <span id="displayName">Loading...</span></p>
  <p><strong>Email:</strong> <span id="displayEmail">Loading...</span></p>
  <p><strong>Course:</strong> <span id="displayCourse"></span></p>
  <p><strong>Amount:</strong> <span id="displayPrice"></span></p>

  <label style="font-size: 13px; color: #64748b;">Select Payment Method:</label>
  <select id="method">
    <option value="Ecocash">Ecocash</option>
    <option value="Bank Transfer">Bank Transfer</option>
    <option value="One Money">One Money</option>
  </select>

  <button type="button" onclick="proceedPayment()">Generate Invoice & Proceed</button>
</div>

<div id="invoicePopup">
  <div id="invoiceBox">
    <h3>Payment Invoice</h3>
    <p style="border:none;"><strong>Invoice No:</strong> <span id="invoiceNo"></span></p>

    <div id="invoiceDetails" style="text-align: left; margin: 15px 0;"></div>

    <div class="instruction-box">
      <strong>Payment Instructions:</strong><br>
      üè¶ Bank: CBZ / FBC (Academy Acct)<br>
      üí∞ Ecocash: 0773371163<br>
      üì± One Money: 0718625498<br>
      üìå <strong>Reference:</strong> Use Invoice Number above
    </div>

    <button class="blueBtn" onclick="downloadPDF()">Download PDF Invoice</button>
    <button class="greenBtn" onclick="goBack()">Return to Dashboard</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// --- 1. CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
  authDomain: "students-login-29409.firebaseapp.com",
  projectId: "students-login-29409"
};
firebase.initializeApp(firebaseConfig);

// --- 2. GET DATA FROM URL (Blogger) OR LOCALSTORAGE ---
const urlParams = new URLSearchParams(window.location.search);
const courseName = urlParams.get('name') || localStorage.getItem("courseName") || "N/A";
const coursePrice = urlParams.get('price') || localStorage.getItem("coursePrice") || "0.00";
const invoiceNumber = "FBA-" + Date.now();

// Fill Course Data
document.getElementById("displayCourse").textContent = courseName;
document.getElementById("displayPrice").textContent = "$" + coursePrice;
document.getElementById("invoiceNo").textContent = invoiceNumber;

// --- 3. GET LOGGED IN STUDENT DATA ---
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    // We use the Email from Firebase as the source of truth
    document.getElementById("displayEmail").textContent = user.email;
    // Name is usually stored in LocalStorage from the signup/login form
    document.getElementById("displayName").textContent = localStorage.getItem("studentName") || "Student";
  } else {
    // If not logged in, they shouldn't be here
    window.location.href = "index.html";
  }
});

function proceedPayment(){
  const name = document.getElementById("displayName").textContent;
  const email = document.getElementById("displayEmail").textContent;
  const method = document.getElementById("method").value;

  /* Update Local Status */
  const statusData = JSON.parse(localStorage.getItem("courseStatus")) || {};
  if(!statusData[email]) statusData[email] = {};
  statusData[email][courseName] = "pending";
  localStorage.setItem("courseStatus", JSON.stringify(statusData));

  document.getElementById("invoiceDetails").innerHTML = `
    <strong>Student:</strong> ${name}<br>
    <strong>Course:</strong> ${courseName}<br>
    <strong>Amount:</strong> $${coursePrice}<br>
    <strong>Method:</strong> ${method}<br>
    <strong>Status:</strong> <span style="color:orange">Pending Confirmation</span>
  `;

  document.getElementById("invoicePopup").style.display = "block";
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById("displayName").textContent;

  doc.setFontSize(20);
  doc.setTextColor(30, 58, 138);
  doc.text("Food Business Academy", 20, 25);
  
  doc.setDrawColor(200, 200, 200);
  doc.line(20, 30, 190, 30);

  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(`Invoice Number: ${invoiceNumber}`, 20, 45);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 55);
  doc.text(`Student Name: ${name}`, 20, 65);
  doc.text(`Enrolled Course: ${courseName}`, 20, 75);
  doc.text(`Total Amount: $${coursePrice}`, 20, 85);
  
  doc.setFillColor(245, 245, 245);
  doc.rect(20, 95, 170, 30, 'F');
  doc.text("Payment Instructions:", 25, 105);
  doc.text("Pay via Ecocash 0773371163 or Bank Transfer.", 25, 115);

  doc.save(`Invoice_${invoiceNumber}.pdf`);
}

function goBack(){
  window.location.href = "student.html"; // Redirect to dashboard
}
</script>

</body>
</html>
