<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Payment Preview - Food Business Academy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* ===== YOUR ORIGINAL STYLES (UNCHANGED) ===== */
:root {
--primary:#4f46e5;
--secondary:#7c3aed;
--gradient:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);
--bg-color:#f3f4f6;
--card-bg:#ffffff;
--text-dark:#1f2937;
--text-light:#6b7280;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
font-family:'Poppins',sans-serif;
background:var(--bg-color);
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
padding:20px;
opacity:0;
transition:.5s;
}
body.loaded{opacity:1}

.container{
max-width:500px;
background:#fff;
padding:40px 30px;
border-radius:20px;
box-shadow:0 20px 40px rgba(79,70,229,.15);
text-align:center;
border-top:5px solid var(--secondary)
}
.logo-img{max-width:150px;margin:0 auto 20px}
h2{font-size:22px;font-weight:700}
.sub-text{font-size:14px;color:var(--text-light);margin-bottom:25px}

.details-box{
background:#f9fafb;
border-radius:12px;
padding:20px;
margin-bottom:25px;
border:1px dashed #d1d5db;
text-align:left
}
.detail-row{display:flex;justify-content:space-between;margin-bottom:12px}
.value{color:var(--primary);font-weight:600}

.payment-grid{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:12px;
margin-bottom:25px
}
.payment-card{
border:2px solid #e5e7eb;
border-radius:12px;
height:80px;
display:flex;
align-items:center;
justify-content:center;
cursor:pointer;
}
.payment-card.active{
border-color:var(--secondary);
background:#f5f3ff
}

.main-btn{
width:100%;
padding:16px;
background:var(--gradient);
color:#fff;
border:none;
border-radius:12px;
font-size:16px;
font-weight:600;
cursor:pointer;
}
</style>
</head>
<body>

<div class="container">
<img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhIuGx_Tl93TWp5OZYxIn7iCPb3FhwXGTZTr_xVjfUAOy4dt2YzXq0c7H4VizrvCBNkCO12IlSymo4R-7Nq9mSffdpB9w6Yge3O2i0UovqE45XIW1jEyvZJg6sOjDfUUhdRJs2x_Bqui6goNnXmcV8hguXwcIUqsvMv5-kY-yNeo-Onr9TVspl88fBfiEsV/s1600/IMG-20251223-WA0001.png" class="logo-img">

<h2>Enrollment Summary</h2>
<p class="sub-text">Please review your details and select a payment method.</p>

<div class="details-box">
<div class="detail-row"><span>Email:</span><span id="displayEmail">...</span></div>
<div class="detail-row"><span>Course:</span><span id="displayCourse">...</span></div>
<div class="detail-row"><span>Total:</span><span id="displayPrice">...</span></div>
</div>

<input type="hidden" id="method" value="Ecocash">

<div class="payment-grid">
<div class="payment-card active" onclick="selectPayment('Ecocash',this)">
<img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhCOPxJALDl8rinCr4j5gKvHQCpFn5RjSNX4o2ZgKZdus_g_naLRz35VcSQknCqVYUWWrhpmE_f3OOPgnjByqIM4JFYeB_0ZKCQxlRgesgK5PoPxo4JjacOmrmyTXpzf-bAfc6ZEt8_88LFQZEEUN1p9yb-zdoqKA8UrGntxMjWrC6dcYZQi0rK3i27jDOa/s1600/EcoCash%20%281%29.png">
</div>
</div>

<button class="main-btn" onclick="proceedPayment()">Generate Invoice & Pay</button>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== FIREBASE INIT (UNCHANGED) ===== */
firebase.initializeApp({
apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
authDomain:"students-login-29409.firebaseapp.com",
projectId:"students-login-29409"
});
const db=firebase.firestore();

const url=new URLSearchParams(window.location.search);
const courseName=url.get("name")||localStorage.getItem("courseName");
const coursePrice=url.get("price")||localStorage.getItem("coursePrice");

let studentEmail="";

/* ===== AUTH + INVOICE CHECK ===== */
firebase.auth().onAuthStateChanged(async user=>{
if(!user){window.location.href="index.html";return;}
studentEmail=user.email;

document.getElementById("displayEmail").textContent=studentEmail;
document.getElementById("displayCourse").textContent=courseName;
document.getElementById("displayPrice").textContent="$"+coursePrice;

const invoiceId=`${studentEmail}__${courseName}`;
const invoiceRef=db.collection("invoices").doc(invoiceId);
const snap=await invoiceRef.get();

/* ðŸ”’ BLOCK DUPLICATES HERE */
if(snap.exists){
console.log("Invoice already exists â†’ redirecting");
window.location.href="student.html";
return;
}

document.body.classList.add("loaded");
});

/* ===== PAYMENT METHOD ===== */
function selectPayment(m,el){
document.getElementById("method").value=m;
document.querySelectorAll(".payment-card").forEach(c=>c.classList.remove("active"));
el.classList.add("active");
}

/* ===== GENERATE INVOICE (ONCE ONLY) ===== */
async function proceedPayment(){
const btn=document.querySelector(".main-btn");
btn.disabled=true;

const invoiceId=`${studentEmail}__${courseName}`;
const invoiceRef=db.collection("invoices").doc(invoiceId);
const snap=await invoiceRef.get();

if(snap.exists){
window.location.href="student.html";
return;
}

const invNum="FBA-"+Math.floor(100000+Math.random()*900000);

await invoiceRef.set({
email:studentEmail,
course:courseName,
price:coursePrice,
invoiceNumber:invNum,
status:"pending",
createdAt:firebase.firestore.FieldValue.serverTimestamp()
});

/* Update enrollment status */
await db.collection("enrollments").doc(studentEmail).set({
[courseName]:"pending"
},{merge:true});

/* Redirect after creation */
window.location.href="student.html";
}
</script>

</body>
</html>
