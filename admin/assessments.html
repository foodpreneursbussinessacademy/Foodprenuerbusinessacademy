<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPBA Admin Inbox</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME VARIABLES (MATCHING YOUR WIDGET) --- */
        :root {
            --fp-purple: #6a1b9a;
            --fp-blue: #1565c0;
            --fp-lavender: #e1bee7;
            --fp-red: #d32f2f;
            --fp-yellow: #fbc02d;
            --fp-bg-grey: #f4f6f8;
            --text-dark: #2c3e50;
            --text-grey: #607d8b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--fp-bg-grey);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--fp-purple), var(--fp-blue));
            color: white;
            padding: 20px 20px 60px 20px; /* Extra bottom padding for overlap effect */
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        /* --- CONTAINER --- */
        .container {
            max-width: 600px;
            margin: -40px auto 20px auto; /* Negative top margin to pull over header */
            padding: 0 15px;
            position: relative;
            z-index: 101;
        }

        /* --- INBOX CARDS --- */
        .submission-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-left: 5px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .submission-card:active { transform: scale(0.98); }
        
        /* Status Borders based on Stage (Assigned via JS) */
        .status-new { border-left-color: var(--fp-blue); } /* 0-1 Year */
        .status-idea { border-left-color: var(--fp-lavender); } /* Idea */
        .status-pro { border-left-color: var(--fp-purple); } /* 3+ Years */

        /* Header of the Card */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .student-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: var(--text-dark);
        }

        .timestamp {
            font-size: 11px;
            color: var(--text-grey);
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 10px;
        }

        .card-summary {
            font-size: 14px;
            color: var(--text-grey);
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tag-crop { background: #e3f2fd; color: var(--fp-blue); }
        .tag-stage { background: #f3e5f5; color: var(--fp-purple); }

        /* --- EXPANDED DETAILS (Hidden by default) --- */
        .details-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            border-top: 1px solid #eee;
            margin-top: 0;
            opacity: 0;
        }

        .submission-card.expanded .details-panel {
            max-height: 1000px; /* Arbitrary large number */
            margin-top: 15px;
            padding-top: 15px;
            opacity: 1;
        }

        .qa-pair {
            margin-bottom: 15px;
        }

        .question-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--fp-purple);
            font-weight: 700;
            margin-bottom: 4px;
        }

        .answer-text {
            font-size: 15px;
            color: #333;
            line-height: 1.5;
        }

        .action-row {
            margin-top: 20px;
            text-align: right;
        }

        .btn-email {
            background: var(--fp-blue);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        /* Loading State */
        #loading {
            text-align: center;
            padding: 40px;
            color: var(--text-grey);
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        /* Toggle Icon */
        .toggle-icon {
            font-size: 20px;
            color: #ccc;
            transition: transform 0.3s;
        }
        .submission-card.expanded .toggle-icon {
            transform: rotate(180deg);
        }

    </style>
</head>
<body>

    <header>
        <h1>
            FPBA Inbox
            <button class="refresh-btn" onclick="location.reload()">Refresh</button>
        </h1>
        <p style="margin: 5px 0 0; font-size: 13px; opacity: 0.9;">Real-time student assessments</p>
    </header>

    <div class="container" id="cards-container">
        <div id="loading">Loading Assessments...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- 1. CONFIGURATION (Same as your widget) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
            authDomain: "students-login-29409.firebaseapp.com",
            projectId: "students-login-29409",
            storageBucket: "students-login-29409.firebasestorage.app",
            messagingSenderId: "634331456872",
            appId: "1:634331456872:web:6dae360c5e28d8356562dd",
            measurementId: "G-96XXYG1VR2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const container = document.getElementById("cards-container");

        // --- 2. FETCH DATA ---
        // We use onSnapshot for real-time updates. 
        // We try to order by 'submittedAt' descending (Newest first).
        // Note: If this fails due to missing index, it will log a link in console to create it.
        
        const q = query(collection(db, "student_assessments"), orderBy("submittedAt", "desc"));

        onSnapshot(q, (snapshot) => {
            container.innerHTML = ""; // Clear loading/old data

            if (snapshot.empty) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size:40px; margin-bottom:10px;">ðŸ“­</div>
                        No assessments received yet.
                    </div>`;
                return;
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                const card = createCard(doc.id, data);
                container.appendChild(card);
            });
        }, (error) => {
            console.error("Error fetching data: ", error);
            container.innerHTML = `<div style="text-align:center; padding:20px; color:red;">Error loading data.<br>Check console for details.</div>`;
        });

        // --- 3. HELPER FUNCTIONS ---

        // Format Date
        function formatTime(timestamp) {
            if (!timestamp) return "Just now";
            const date = timestamp.toDate();
            // Short format: "Jan 1, 14:30"
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + 
                   ", " + 
                   date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        }

        // Determine Tag Color based on stage
        function getStageClass(stage) {
            if(!stage) return "";
            if(stage.includes("Idea")) return "status-idea";
            if(stage.includes("3+")) return "status-pro";
            return "status-new";
        }

        // --- 4. CREATE CARD HTML ---
        function createCard(id, data) {
            const div = document.createElement("div");
            
            // Assign Border Color Class
            const stageClass = getStageClass(data.stage);
            div.className = `submission-card ${stageClass}`;
            
            // Extract Key Info
            const name = data.name || "Anonymous";
            const email = data.email || "";
            const crops = data.crops || "Unknown Crops";
            const goal = data.goal || "No goal stated";
            const time = formatTime(data.submittedAt);
            const stage = data.stage || "Unknown Stage";

            div.innerHTML = `
                <div class="card-header">
                    <div class="student-name">${name}</div>
                    <div class="timestamp">${time}</div>
                </div>
                
                <div class="card-summary">
                    <span class="tag tag-stage">${stage}</span>
                    <span class="tag tag-crop">${crops}</span>
                </div>
                
                <div style="font-size:13px; color:#555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    Goal: ${goal}
                </div>
                
                <div style="text-align:center; margin-top:10px;">
                     <div class="toggle-icon">âŒ„</div>
                </div>

                <div class="details-panel">
                    ${renderDetail("Email", email)}
                    ${renderDetail("Crops", crops)}
                    ${renderDetail("Current Losses", data.waste)}
                    ${renderDetail("Value Addition Interest", data.interest)}
                    ${renderDetail("Processing Status", data.processing)}
                    ${renderDetail("Business Stage", stage)}
                    ${renderDetail("Financial Records", data.finance)}
                    ${renderDetail("Market Channel", data.market)}
                    ${renderDetail("Primary Goal", goal)}
                    
                    <div class="action-row">
                        <a href="mailto:${email}?subject=FPBA%20Course%20Recommendation" class="btn-email">Reply via Email</a>
                    </div>
                </div>
            `;

            // Add Click Event to Toggle
            div.addEventListener("click", function() {
                this.classList.toggle("expanded");
            });

            return div;
        }

        function renderDetail(label, value) {
            if(!value) return "";
            return `
                <div class="qa-pair">
                    <div class="question-label">${label}</div>
                    <div class="answer-text">${value}</div>
                </div>
            `;
        }

    </script>
</body>
</html>
