<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Management Course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
*{box-sizing:border-box}
html,body{overflow-x:hidden}
body{
  font-family:Segoe UI,system-ui;
  background:#f1f5f9;
  padding:10px;
  margin:0;
}
body.dark{background:#0f172a;color:#f8fafc}

/* HEADER */
header{
background:#4f46e5;
color:#fff;
padding:14px;
border-radius:14px;
display:flex;
flex-direction:column;
gap:10px;
}
.header-top{
display:flex;
justify-content:space-between;
align-items:center;
}
.header-left{
display:flex;
gap:10px;
align-items:center;
}
.header-left i{font-size:22px}
.header-right{
display:flex;
gap:10px;
align-items:center;
}
.header-chip{
background:rgba(255,255,255,.15);
padding:6px 10px;
border-radius:20px;
font-size:12px;
white-space:nowrap;
}
.theme-btn{
background:rgba(255,255,255,.2);
border:none;
border-radius:50%;
width:36px;
height:36px;
font-size:16px;
cursor:pointer;
color:#fff;
}

/* CARDS */
.card{
background:#fff;
padding:14px;
border-radius:14px;
margin-top:12px;
animation:fadeIn .25s ease;
overflow:hidden;
}
body.dark .card{background:#1e293b}

@keyframes fadeIn{
from{opacity:0;transform:translateY(6px)}
to{opacity:1;transform:none}
}

/* INPUTS */
input,button{
width:100%;
padding:12px;
margin:6px 0;
font-size:15px;
}
input{
border:1px solid #e5e7eb;
border-radius:10px;
}
button{
border:none;
border-radius:12px;
font-weight:600;
cursor:pointer;
transition:transform .15s ease,box-shadow .15s ease;
}
button:active{transform:scale(.96)}

/* BUTTON COLORS */
.publish{background:#16a34a;color:#fff}
.draft{background:#f59e0b;color:#000}
.delete{background:#dc2626;color:#fff}
.view{background:#0ea5e9;color:#fff}

/* QUIZ */
.quiz{
background:#eef2ff;
padding:10px;
border-radius:10px;
margin:8px 0;
display:flex;
flex-direction:column;
gap:6px;
}
body.dark .quiz{background:#334155}

/* TABS */
.tabs{
display:flex;
gap:8px;
margin-top:14px;
}
.tabs button{flex:1;background:#e5e7eb}
.tabs button.active{background:#4f46e5;color:#fff}

/* QUILL CUSTOM STYLES */
#quill{
border-radius:12px;
overflow:hidden;
background: #fff;
}
.ql-editor{
font-size:15px;
line-height:1.6;
padding:12px;
min-height: 200px;
}
.ql-editor img{
max-width:100%;
height:auto;
display:block;
margin:12px auto;
border-radius:10px;
}

/* IFRAME & VIDEO SUPPORT */
.ql-editor iframe, .ql-video {
  width: 100%;
  height: 250px;
  border: none;
  border-radius: 10px;
  margin: 10px 0;
  background: #000;
}
body.dark #quill { color: #000; }

.viewer img, .viewer iframe{
max-width:100%;
width:100%;
height:auto;
}
.viewer iframe { height: 250px; }

/* TOAST */
#toast{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:#111827;
color:#fff;
padding:12px 16px;
border-radius:14px;
display:flex;
gap:10px;
align-items:center;
z-index:9999;
animation:fadeIn .2s ease;
}
#toast.hidden{display:none}

.hidden{display:none}

/* MOBILE */
@media(min-width:768px){
body{max-width:720px;margin:auto}
}
</style>
</head>

<body>

<header>
  <div class="header-top">
    <div class="header-left">
      <i class="fa fa-user-shield"></i>
      <b>Management Course</b>
    </div>
    <div class="header-right">
      <div id="authStatus" class="header-chip">Checkingâ€¦</div>
      <button class="theme-btn" onclick="toggleTheme()">ðŸŒ“</button>
    </div>
  </div>
</header>

<div id="toast" class="hidden">
  <i class="fa fa-spinner fa-spin"></i>
  <span id="toastText"></span>
</div>

<div class="card hidden" id="addModuleCard">
  <button class="publish" onclick="openEditor()">âž• Add New Module</button>
</div>

<div class="card hidden" id="editor">
  <h3>Module Editor</h3>
  <input id="title" placeholder="Module title">
  <input id="videoUrl" placeholder="Video URL (Optional header video)">
  
  <div id="quill" style="height:auto"></div>

  <h4>Quizzes</h4>
  <input id="q" placeholder="Question">
  <input id="o1" placeholder="Option 1">
  <input id="o2" placeholder="Option 2">
  <input id="o3" placeholder="Option 3">
  <input id="o4" placeholder="Option 4">
  <input id="a" placeholder="Correct answer">

  <button onclick="addQuiz()">Add / Update Quiz</button>
  <div id="quizList"></div>

  <button class="draft" onclick="saveModule('draft')">Save Draft</button>
  <button class="publish" onclick="saveModule('published')">Publish</button>
</div>

<div class="tabs">
  <button class="active" onclick="showTab('publishedTab',this)">Published</button>
  <button onclick="showTab('draftTab',this)">Drafts</button>
  <button onclick="showTab('binTab',this)">Recycle Bin</button>
</div>

<div class="card" id="publishedTab"></div>
<div class="card hidden" id="draftTab"></div>
<div class="card hidden" id="binTab"></div>
<div class="card hidden viewer" id="viewer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, getDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ðŸ”’ STRICTLY KEEPS MANAGEMENT COURSE ID */
const COURSE_ID = "management_course";

const app = initializeApp({
apiKey:"AIzaSyC_lKWa4cM4cT337KkRw4sp7raQHl9aZWk",
authDomain:"students-login-29409.firebaseapp.com",
projectId:"students-login-29409"
});

const db = getFirestore(app);
const auth = getAuth(app);
signInWithEmailAndPassword(auth,"ADMIN_EMAIL","ADMIN_PASSWORD");

onAuthStateChanged(auth, async user=>{
if(!user){authStatus.innerText="Not logged in";return;}
const admin = await getDoc(doc(db,"admins",user.uid));
if(!admin.exists()){authStatus.innerText="Not admin";return;}
authStatus.innerText="Admin Verified";
addModuleCard.classList.remove("hidden");
loadModules();
});

/* --- UPDATED QUILL SETUP (MATCHING OTHER FILE) --- */
const quill = new Quill("#quill",{
  theme:"snow",
  modules:{
    toolbar:{
      container:[
        [{header:[1,2,3,false]}],
        ["bold","italic","underline"],
        [{list:"ordered"},{list:"bullet"}],
        ["link", "image", "video"], /* Video button = Iframe */
        ["code-block"] /* Code block button = Paste HTML */
      ],
      handlers:{
        image: imageHandler,
        /* Custom Handler: Video button acts as 'Insert Iframe from Link' */
        video: function() {
            const url = prompt("Enter the link/URL you want to display in an iframe:");
            if(url){
               const html = `<iframe class="ql-video" frameborder="0" allowfullscreen="true" src="${url}"></iframe>`;
               const range = this.quill.getSelection(true);
               this.quill.clipboard.dangerouslyPasteHTML(range.index, html);
            }
        },
        /* Custom Handler: Code-block button acts as 'Insert Raw HTML' */
        'code-block': function() {
            const html = prompt("Paste your HTML code here:");
            if(html){
                const range = this.quill.getSelection(true);
                this.quill.clipboard.dangerouslyPasteHTML(range.index, html);
            }
        }
      }
    }
  }
});

function imageHandler(){
  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";
  input.click();

  input.onchange=()=>{
    const file=input.files[0];
    if(!file)return;

    toastText.innerText="Uploading image 0%";
    toast.classList.remove("hidden");

    const reader=new FileReader();
    reader.onprogress=e=>{
      if(e.lengthComputable){
        toastText.innerText=`Uploading image ${Math.round((e.loaded/e.total)*100)}%`;
      }
    };
    reader.onload=()=>{
      const range=quill.getSelection(true);
      quill.insertEmbed(range.index,"image",reader.result);
      toastText.innerText="Image uploaded";
      setTimeout(()=>toast.classList.add("hidden"),1200);
    };
    reader.readAsDataURL(file);
  };
}
/* --- END QUILL SETUP --- */

let quizzes=[],editingId=null,editingQuiz=null;

window.addQuiz=()=>{
const quiz={question:q.value,options:[o1.value,o2.value,o3.value,o4.value],answer:a.value};
editingQuiz!==null?quizzes[editingQuiz]=quiz:quizzes.push(quiz);
editingQuiz=null;
q.value=o1.value=o2.value=o3.value=o4.value=a.value="";
renderQuizzes();
};

function renderQuizzes(){
quizList.innerHTML="";
quizzes.forEach((x,i)=>{
quizList.innerHTML+=`<div class="quiz">
<b>${i+1}. ${x.question}</b>
<button onclick="editQuiz(${i})">Edit</button>
<button class="delete" onclick="deleteQuiz(${i})">Delete</button>
</div>`;
});
}

window.editQuiz=i=>{
const x=quizzes[i];
q.value=x.question;
[o1.value,o2.value,o3.value,o4.value]=x.options;
a.value=x.answer;
editingQuiz=i;
};

window.deleteQuiz=i=>{quizzes.splice(i,1);renderQuizzes();};

window.saveModule=async status=>{
toastText.innerText=status==="published"?"Publishing...":"Saving draft...";
toast.classList.remove("hidden");
// Uses COURSE_ID to ensure we save to Management Course
const refc=collection(db,"courses",COURSE_ID,"modules");
const data={title:title.value,videoUrl:videoUrl.value,content:quill.root.innerHTML,quizzes,status,updatedAt:serverTimestamp()};
editingId?await updateDoc(doc(refc,editingId),data):await addDoc(refc,data);
toast.classList.add("hidden");
reset();loadModules();
};

async function loadModules(){
publishedTab.innerHTML=draftTab.innerHTML=binTab.innerHTML="";
let n=1;
// Uses COURSE_ID to ensure we load from Management Course
const s=await getDocs(query(collection(db,"courses",COURSE_ID,"modules"),orderBy("updatedAt","desc")));
s.forEach(d=>{
const m=d.data();
const t=m.status==="published"?`${n++}. ${m.title}`:m.title;
const box=`<div class="quiz">
<b>${t}</b>
<button class="view" onclick="viewModule('${d.id}')">View</button>
<button onclick="edit('${d.id}')">Edit</button>
<button class="delete" onclick="softDelete('${d.id}')">Delete</button>
</div>`;
(m.status==="published"?publishedTab:m.status==="draft"?draftTab:binTab).innerHTML+=box;
});
}

window.viewModule=async id=>{
history.pushState({page:"viewer"},"");
// Uses COURSE_ID
const s=await getDoc(doc(db,"courses",COURSE_ID,"modules",id));
const m=s.data();
viewer.innerHTML=`<h3>${m.title}</h3>${m.content}<button onclick="history.back()">â¬… Back</button>`;
viewer.classList.remove("hidden");
};

window.onpopstate=()=>{
viewer.classList.add("hidden");
editor.classList.add("hidden");
};

window.edit=async id=>{
history.pushState({page:"editor"},"");
// Uses COURSE_ID
const s=await getDoc(doc(db,"courses",COURSE_ID,"modules",id));
const m=s.data();
title.value=m.title;
videoUrl.value=m.videoUrl;
quill.root.innerHTML=m.content;
quizzes=m.quizzes||[];
editingId=id;
editor.classList.remove("hidden");
renderQuizzes();
};

window.softDelete=async id=>{
// Uses COURSE_ID
await updateDoc(doc(db,"courses",COURSE_ID,"modules",id),{status:"deleted"});
loadModules();
};

function reset(){
title.value=videoUrl.value="";
quill.root.innerHTML="";
quizzes=[];
editingId=null;
renderQuizzes();
}

window.openEditor=()=>{
history.pushState({page:"editor"},"");
editor.classList.remove("hidden");
};

window.showTab=(id,btn)=>{
["publishedTab","draftTab","binTab"].forEach(t=>document.getElementById(t).classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
};

window.toggleTheme=()=>document.body.classList.toggle("dark");
</script>

</body>
</html>
